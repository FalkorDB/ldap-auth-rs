# Kubernetes Deployment Quick Reference

## ÔøΩ Prerequisites

```bash
# 1. Install StringSecret operator (for auto-generated secrets)
kubectl apply -f https://github.com/mittwald/kubernetes-secret-generator/releases/latest/download/secret-generator.yaml
```

## ÔøΩüöÄ Deploy Commands

```bash
# Development
kubectl apply -k k8s/overlays/dev
kubectl get all -n ldap-auth-dev

# Staging
kubectl apply -k k8s/overlays/staging
kubectl get all -n ldap-auth-staging

# Production (review first!)
kubectl diff -k k8s/overlays/production
kubectl apply -k k8s/overlays/production
kubectl get all -n ldap-auth-prod
```

## üîç Preview Before Deploy

```bash
# Generate manifests without applying
kubectl kustomize k8s/overlays/dev > preview-dev.yaml
kubectl kustomize k8s/overlays/production > preview-prod.yaml

# Review differences
diff preview-dev.yaml preview-prod.yaml
```

## üîê Update Secrets (Production)

**Note:** Secrets are now auto-generated by StringSecret operator!

### View Generated Secrets

```bash
# Wait for StringSecret to generate secret
kubectl wait --for=condition=Ready stringsecret/ldap-auth-secrets -n ldap-auth-prod --timeout=60s

# View generated secret (base64 encoded)
kubectl get secret ldap-auth-secrets -n ldap-auth-prod -o yaml

# Decode specific field
kubectl get secret ldap-auth-secrets -n ldap-auth-prod \
  -o jsonpath='{.data.ADMIN_PASSWORD}' | base64 -d && echo
```

### Rotate Secrets

```bash
# Delete StringSecret to trigger regeneration
kubectl delete stringsecret ldap-auth-secrets -n ldap-auth-prod

# Wait for regeneration
kubectl wait --for=condition=Ready stringsecret/ldap-auth-secrets -n ldap-auth-prod

# Restart pods to use new secrets
kubectl rollout restart deployment/ldap-auth-rs -n ldap-auth-prod
kubectl rollout restart statefulset/redis -n ldap-auth-prod
```

### Manual Secrets (Fallback)

If StringSecret operator is not available, uncomment the fallback Secret in `k8s/base/secret.yaml`:

```bash
# Generate secure passwords
export ADMIN_PASSWORD=$(openssl rand -base64 32)
export JWT_SECRET=$(openssl rand -base64 64)
export REDIS_PASSWORD=$(openssl rand -base64 32)

# Apply secrets
kubectl create secret generic ldap-auth-secrets \
  --from-literal=ADMIN_USERNAME=admin \
  --from-literal=ADMIN_PASSWORD=$ADMIN_PASSWORD \
  --from-literal=JWT_SECRET=$JWT_SECRET \
  --from-literal=REDIS_PASSWORD=$REDIS_PASSWORD \
  -n ldap-auth-prod \
  --dry-run=client -o yaml | kubectl apply -f -
```

## üíæ Redis Backups

Use cloud provider native backup solutions for Redis data.

**AWS EBS:**
```bash
# Find EBS volume ID
VOL_ID=$(kubectl get pv $(kubectl get pvc redis-data-redis-0 -n ldap-auth-prod -o jsonpath='{.spec.volumeName}') -o jsonpath='{.spec.awsElasticBlockStore.volumeID}')

# Create snapshot
aws ec2 create-snapshot --volume-id $VOL_ID --description "Redis backup $(date +%Y%m%d)"
```

**GCP Persistent Disk:**
```bash
# Find disk name
DISK_NAME=$(kubectl get pv $(kubectl get pvc redis-data-redis-0 -n ldap-auth-prod -o jsonpath='{.spec.volumeName}') -o jsonpath='{.spec.gcePersistentDisk.pdName}')

# Create snapshot
gcloud compute disks snapshot $DISK_NAME --snapshot-names=redis-backup-$(date +%Y%m%d)
```

**Azure Disk:**
```bash
# Get disk resource ID
DISK_ID=$(kubectl get pv $(kubectl get pvc redis-data-redis-0 -n ldap-auth-prod -o jsonpath='{.spec.volumeName}') -o jsonpath='{.spec.azureDisk.diskURI}')

# Create snapshot
az snapshot create --resource-group myRG --source $DISK_ID --name redis-backup-$(date +%Y%m%d)
```

**Redis Native:**
```bash
# Trigger RDB save
kubectl exec -it redis-0 -n ldap-auth-prod -- redis-cli -a $REDIS_PASSWORD BGSAVE

# Copy backup file
kubectl cp ldap-auth-prod/redis-0:/data/dump.rdb ./redis-backup-$(date +%Y%m%d).rdb
```

See [SECRETS_AND_BACKUPS.md](SECRETS_AND_BACKUPS.md) for detailed restore procedures.

## üåê Access Service

### Internal Access (Default)

```bash
# From another pod in the cluster
curl http://ldap-auth-service.ldap-auth-prod.svc.cluster.local:8080/health

# Service DNS names
ldap-auth-service.ldap-auth-prod.svc.cluster.local:8080  # HTTP API
ldap-auth-service.ldap-auth-prod.svc.cluster.local:3389  # LDAP
```

### Port Forward (Development)

```bash
# Forward to local machine
kubectl port-forward svc/ldap-auth-service 8080:8080 -n ldap-auth-prod

# Access locally
curl http://localhost:8080/health
ldap-auth-cli --url http://localhost:8080 user list
```

### External Access (Not Recommended)

**‚ö†Ô∏è This service is internal-only by default.**

To enable external access (staging/production testing only):

1. Edit `k8s/overlays/production/kustomization.yaml`
2. Uncomment `- ingress.yaml` under resources
3. Edit `k8s/overlays/production/ingress.yaml` 
4. Uncomment the Ingress manifest
5. Update hostname and TLS settings
6. Apply: `kubectl apply -k k8s/overlays/production`

## üîÑ Update Image

```bash
# Set new image tag
cd k8s/overlays/production
kustomize edit set image ldap-auth-rs:v1.2.3
kubectl apply -k .

# Watch rollout
kubectl rollout status deployment/prod-ldap-auth-rs -n ldap-auth-prod
```

## üìä Monitoring

```bash
# Check pod status
kubectl get pods -n ldap-auth-prod -w

# View logs
kubectl logs -f deployment/ldap-auth-rs -n ldap-auth-prod

# Check HPA
kubectl get hpa -n ldap-auth-prod

# Port forward for local testing
kubectl port-forward svc/ldap-auth-service 8080:8080 -n ldap-auth-prod
curl http://localhost:8080/health
```

## üß™ Test Deployment

```bash
# Health check
kubectl exec -it deployment/ldap-auth-rs -n ldap-auth-prod -- \
  wget -qO- http://localhost:8080/health

# Redis connectivity
kubectl exec -it deployment/ldap-auth-rs -n ldap-auth-prod -- \
  nc -zv redis-service 6379

# CLI tool
kubectl exec -it deployment/ldap-auth-rs -n ldap-auth-prod -- \
  ldap-auth-cli --help
```

## üîÑ Rollback

```bash
# View history
kubectl rollout history deployment/ldap-auth-rs -n ldap-auth-prod

# Rollback
kubectl rollout undo deployment/ldap-auth-rs -n ldap-auth-prod
```

## üßπ Cleanup

```bash
# Remove specific environment
kubectl delete -k k8s/overlays/dev

# Or delete namespace
kubectl delete namespace ldap-auth-dev
```

## üìà Scale Manually

```bash
# Scale app
kubectl scale deployment ldap-auth-rs --replicas=5 -n ldap-auth-prod

# Scale redis (if using multiple replicas)
kubectl scale statefulset redis --replicas=3 -n ldap-auth-prod
```

## üêõ Troubleshooting

```bash
# Describe pod
kubectl describe pod <pod-name> -n ldap-auth-prod

# Events
kubectl get events -n ldap-auth-prod --sort-by='.lastTimestamp'

# Check resources
kubectl top pods -n ldap-auth-prod
kubectl top nodes

# Network policy test
kubectl exec -it deployment/ldap-auth-rs -n ldap-auth-prod -- \
  nc -zv redis-service 6379
```

## üìã Resource Overview

| Environment | Namespace | Replicas | HPA Min/Max | CPU Req | Mem Req | Redis Mem |
|-------------|-----------|----------|-------------|---------|---------|-----------|
| Dev | ldap-auth-dev | 1 | 1/3 | 50m | 64Mi | 256MB |
| Staging | ldap-auth-staging | 2 | 2/10 | 75m | 96Mi | 256MB |
| Production | ldap-auth-prod | 3 | 3/20 | 100m | 128Mi | 1GB |

## üîí Security Checklist

- [ ] Install StringSecret operator for secure secret generation
- [ ] Test Redis persistence in staging
- [ ] Configure cloud provider backup solution (AWS Backup, GCP snapshots, etc.)
- [ ] Replace default secrets in production (if not using StringSecret)
- [ ] **Verify service is ClusterIP (internal-only)**
- [ ] **Do NOT enable Ingress unless absolutely necessary**
- [ ] If Ingress required: Configure rate limiting, IP allowlist, mTLS
- [ ] Review network policies (default: internal cluster access only)
- [ ] Set up external secret management (optional: Vault, External Secrets)
- [ ] Enable Pod Security Standards
- [ ] Configure RBAC appropriately
- [ ] Enable audit logging
- [ ] Set up monitoring/alerting
- [ ] Test disaster recovery procedures
- [ ] Document internal service access patterns for consumers
