name: CI/CD Pipeline

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]
  release:
    types: [ created ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  REGISTRY: docker.io
  IMAGE_NAME: falkordb/ldap-auth-rs
  RUSTFLAGS: "-C debuginfo=0"
  CARGO_INCREMENTAL: 0

concurrency:
  group: ci-cd-pipeline-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features --no-deps -- -D warnings

  unit-test:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Run unit tests (no integration tests)
        run: cargo test --lib --bins
        env:
          RUST_BACKTRACE: 1

  rust-integration-tests:
    name: Rust Integration Tests
    runs-on: ubuntu-latest
    needs: unit-test

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build server binary (for ldap3 tests)
        run: cargo build --bin ldap-auth-rs

      - name: Start ldap-auth-rs (for ldap3 tests)
        run: |
          set -euo pipefail
          ./target/debug/ldap-auth-rs &
          LDAP_AUTH_PID=$!
          echo "LDAP_AUTH_PID=$LDAP_AUTH_PID" >> $GITHUB_ENV

          echo "Waiting for API health endpoint..."
          for i in $(seq 1 60); do
            if curl -fsS http://127.0.0.1:8080/health >/dev/null; then
              echo "API is up"
              exit 0
            fi
            sleep 1
          done
          echo "API did not become ready in time" >&2
          kill "$LDAP_AUTH_PID" || true
          exit 1
        env:
          # Server configuration
          API_PORT: 8080
          LDAP_PORT: 3389
          LDAP_BASE_DN: dc=example,dc=com
          API_BEARER_TOKEN: asdf
          REDIS_HOST: 127.0.0.1
          REDIS_PORT: 6379
          RUST_LOG: info

      - name: Run Rust integration tests (includes ldap3)
        run: cargo test --tests -- --test-threads=1
        env:
          TEST_REDIS_URL: redis://127.0.0.1:6379/15
          RUN_LDAP3_TESTS: 1
          TEST_API_BASE_URL: http://127.0.0.1:8080
          TEST_API_TOKEN: asdf
          TEST_LDAP_URL: ldap://127.0.0.1:3389
          RUST_BACKTRACE: 1

      - name: Stop ldap-auth-rs
        if: always()
        run: |
          if [ -n "${LDAP_AUTH_PID:-}" ]; then
            kill "$LDAP_AUTH_PID" || true
          fi

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, rust-integration-tests]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build release binaries
        run: cargo build --release

      - name: Upload binaries as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-binaries
          path: |
            target/release/ldap-auth-rs
            target/release/ldap-auth-cli
          retention-days: 1

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [build, rust-integration-tests]

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download binaries
        uses: actions/download-artifact@v7
        with:
          name: release-binaries
          path: target/release/

      - name: Make binaries executable
        run: chmod +x target/release/ldap-auth-rs target/release/ldap-auth-cli

      - name: Start LDAP server for compliance tests
        run: |
          # Start LDAP auth server in background
          ./target/release/ldap-auth-rs &
          LDAP_PID=$!
          sleep 5
          
          # Keep server running for tests
          echo "LDAP_PID=$LDAP_PID" >> $GITHUB_ENV
        env:
          RUST_LOG: info
          REDIS_HOST: 127.0.0.1
          REDIS_PORT: 6379
          LDAP_PORT: 3389
          LDAP_BASE_DN: dc=example,dc=com
          API_BEARER_TOKEN: admin

      - name: Install LDAP tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ldap-utils

      - name: Run LDAP compliance tests
        run: |
          chmod +x tests/ldap_compliance_test.sh
          ./tests/ldap_compliance_test.sh
        env:
          LDAP_HOST: localhost
          LDAP_PORT: 3389
          BASE_DN: dc=example,dc=com
          TEST_ORG: testorg
          TEST_USER: testuser
          TEST_PASSWORD: testpass123
          API_HOST: localhost:8080
          API_TOKEN: admin

      - name: Cleanup LDAP server
        if: always()
        run: |
          kill $LDAP_PID || true

      - name: Run CLI sanity tests
        run: |
          chmod +x tests/cli_sanity_test.sh
          ./tests/cli_sanity_test.sh
        env:
          CLI_CMD: ./target/release/ldap-auth-cli

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-binstall
        run: |
          curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash

      - name: Install cargo-audit
        run: cargo binstall --no-confirm cargo-audit

      - name: Run security audit
        run: cargo audit

      - name: Run vulnerability scan with Trivy
        uses: aquasecurity/trivy-action@0.29.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  build-amd64:
    name: Build Docker Image (amd64)
    runs-on: ubuntu-latest
    needs: [lint, unit-test, rust-integration-tests, integration-test, security]
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch,suffix=-amd64
            type=ref,event=pr,suffix=-amd64
            type=semver,pattern={{version}},suffix=-amd64
            type=semver,pattern={{major}}.{{minor}},suffix=-amd64
            type=sha,prefix={{branch}}-,suffix=-amd64,enable=${{ github.event_name == 'push' }}
            type=raw,value=latest-amd64,enable={{is_default_branch}}

      - name: Build and push amd64 image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache-amd64
          cache-to: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache-amd64,mode=max
          platforms: linux/amd64

  build-arm64:
    name: Build Docker Image (arm64)
    runs-on: ubuntu-24.04-arm
    needs: [lint, unit-test, rust-integration-tests, integration-test, security]
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch,suffix=-arm64
            type=ref,event=pr,suffix=-arm64
            type=semver,pattern={{version}},suffix=-arm64
            type=semver,pattern={{major}}.{{minor}},suffix=-arm64
            type=sha,prefix={{branch}}-,suffix=-arm64,enable=${{ github.event_name == 'push' }}
            type=raw,value=latest-arm64,enable={{is_default_branch}}

      - name: Build and push arm64 image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache-arm64
          cache-to: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache-arm64,mode=max
          platforms: linux/arm64

  create-manifest:
    name: Create Multi-Arch Manifest
    runs-on: ubuntu-latest
    needs: [build-amd64, build-arm64]
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-,enable=${{ github.event_name == 'push' }}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Create and push manifest
        run: |
          echo "${{ steps.meta.outputs.tags }}" | while IFS= read -r TAG; do
            if [ -n "$TAG" ]; then
              echo "Creating manifest for: $TAG"
              docker buildx imagetools create -t "$TAG" \
                "${TAG}-amd64" \
                "${TAG}-arm64"
              echo "✓ Created manifest: $TAG"
            fi
          done

      - name: Verify multi-arch manifest
        run: |
          docker buildx imagetools inspect ${{ env.IMAGE_NAME }}:latest

      - name: Verify Docker image
        run: |
          docker pull ${{ env.IMAGE_NAME }}:latest
          echo "=== Image Details ==="
          docker images ${{ env.IMAGE_NAME }}:latest --format "Size: {{.Size}}"
          echo "=== Verify binaries exist ==="
          docker run --rm --entrypoint sh ${{ env.IMAGE_NAME }}:latest -c "test -x /app/ldap-auth-rs && echo 'Main binary exists'"
          docker run --rm --entrypoint sh ${{ env.IMAGE_NAME }}:latest -c "command -v ldap-auth-cli >/dev/null && echo 'CLI binary exists'"
          docker run --rm --entrypoint ldap-auth-cli ${{ env.IMAGE_NAME }}:latest --help | head -3
          echo "=== Verify Alpine base ==="
          docker run --rm --entrypoint sh ${{ env.IMAGE_NAME }}:latest -c "cat /etc/os-release | grep 'Alpine Linux'"

      - name: Run CLI sanity tests in Docker
        run: |
          chmod +x tests/cli_sanity_test.sh
          CLI_CMD="docker run --rm --network host --entrypoint ldap-auth-cli ${{ env.IMAGE_NAME }}:latest" ./tests/cli_sanity_test.sh

      - name: Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@0.29.0
        with:
          image-ref: ${{ env.IMAGE_NAME }}:latest
          format: 'sarif'
          output: 'trivy-image-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Check for vulnerabilities
        run: |
          trivy image --severity CRITICAL,HIGH --exit-code 1 ${{ env.IMAGE_NAME }}:latest || \
          echo "⚠️ Warning: Vulnerabilities found in Docker image"

      - name: Upload Docker image scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-image-results.sarif'

  deploy:
    name: Deploy Notification
    runs-on: ubuntu-latest
    needs: [create-manifest]
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Deployment notification
        run: |
          echo "Docker image pushed successfully!"
          echo "Image: ${{ env.IMAGE_NAME }}:latest"
          echo "Pull with: docker pull ${{ env.IMAGE_NAME }}:latest"
